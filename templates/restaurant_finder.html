<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™„è¿‘é¤å»³æœå°‹ - Django æ‡‰ç”¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 36px;
            color: #333;
            margin-bottom: 10px;
        }

        .page-header p {
            font-size: 16px;
            color: #666;
        }

        .search-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .search-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .filter-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .map-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            height: 600px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .results-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            height: 600px;
            overflow-y: auto;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .results-header h2 {
            color: #333;
            font-size: 20px;
        }

        .results-count {
            color: #667eea;
            font-weight: 600;
        }

        .restaurant-card {
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restaurant-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(5px);
        }

        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .restaurant-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .restaurant-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #ffc107;
            font-weight: 600;
        }

        .restaurant-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
        }

        .info-icon {
            width: 20px;
            text-align: center;
        }

        .distance-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-open {
            background: #d4edda;
            color: #155724;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f0f0f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-results-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .map-container {
                height: 400px;
            }

            .search-controls {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .page-header h1 {
                font-size: 28px;
            }

            .search-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>ğŸ½ï¸ é™„è¿‘é¤å»³æœå°‹</h1>
            <p>è¼¸å…¥åœ°å€æˆ–ä½¿ç”¨å®šä½ï¼Œæ‰¾å°‹ 1 å…¬é‡Œå…§çš„ç¾é£Ÿ</p>
        </div>

        <div class="search-section">
            <div class="search-controls">
                <input 
                    type="text" 
                    class="search-input" 
                    id="addressInput" 
                    placeholder="è«‹è¼¸å…¥åœ°å€ï¼Œä¾‹å¦‚ï¼šå°åŒ—å¸‚ä¿¡ç¾©å€å¸‚åºœè·¯ 1 è™Ÿ"
                >
                <button class="btn btn-primary" onclick="searchByAddress()">
                    ğŸ” æœå°‹
                </button>
                <button class="btn btn-secondary" onclick="getCurrentLocation()">
                    ğŸ“ ä½¿ç”¨ç›®å‰ä½ç½®
                </button>
            </div>

            <div class="filter-options">
                <button class="filter-btn active" onclick="filterRestaurants('all')">å…¨éƒ¨é¤å»³</button>
                <button class="filter-btn" onclick="filterRestaurants('rating')">é«˜è©•åˆ† â­</button>
                <button class="filter-btn" onclick="filterRestaurants('open')">ç‡Ÿæ¥­ä¸­ ğŸŸ¢</button>
                <button class="filter-btn" onclick="filterRestaurants('distance')">æœ€è¿‘è·é›¢ ğŸ“</button>
            </div>
        </div>

        <div class="content-grid">
            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="results-container" id="results">
                <div class="no-results">
                    <div class="no-results-icon">ğŸ”</div>
                    <h3>å°šæœªæœå°‹</h3>
                    <p>è«‹è¼¸å…¥åœ°å€æˆ–ä½¿ç”¨å®šä½é–‹å§‹æœå°‹é™„è¿‘é¤å»³</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let service;
        let markers = [];
        let currentFilter = 'all';
        let allRestaurants = [];
        const resultContext = `<div class="results-header">
            <h2>æœå°‹çµæœ</h2>
            <span class="results-count" id="resultsCount">0 é–“é¤å»³</span>
            </div>
        `;

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            // é è¨­ä½ç½®ï¼šå°åŒ—å¸‚æ”¿åºœ
            const defaultLocation = { lat: 25.0375, lng: 121.5637 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultLocation,
                zoom: 15,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            service = new google.maps.places.PlacesService(map);
        }

        // ä½¿ç”¨ç›®å‰ä½ç½®
        function getCurrentLocation() {
            if (navigator.geolocation) {
                showLoading();
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        searchNearbyRestaurants(location);
                    },
                    (error) => {
                        alert('ç„¡æ³•å–å¾—ä½ç½®ï¼š' + error.message);
                        hideLoading();
                    }
                );
            } else {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½åŠŸèƒ½');
            }
        }

        // é€éåœ°å€æœå°‹
        function searchByAddress() {
            const address = document.getElementById('addressInput').value;
            if (!address) {
                alert('è«‹è¼¸å…¥åœ°å€');
                return;
            }

            showLoading();
            const geocoder = new google.maps.Geocoder();
            
            geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    searchNearbyRestaurants({
                        lat: location.lat(),
                        lng: location.lng()
                    });
                } else {
                    alert('ç„¡æ³•æ‰¾åˆ°è©²åœ°å€ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ˜¯å¦æ­£ç¢º');
                    hideLoading();
                }
            });
        }

        // æœå°‹é™„è¿‘é¤å»³
        function searchNearbyRestaurants(location) {
            // ç§»é™¤èˆŠçš„æ¨™è¨˜
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // è¨­å®šåœ°åœ–ä¸­å¿ƒ
            map.setCenter(location);

            // æ–°å¢ç›®å‰ä½ç½®æ¨™è¨˜
            new google.maps.Marker({
                position: location,
                map: map,
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                },
                title: 'æ‚¨çš„ä½ç½®'
            });

            // æœå°‹é™„è¿‘é¤å»³
            const request = {
                location: location,
                radius: 1000, // 1å…¬é‡Œ = 1000å…¬å°º
                type: 'restaurant'
            };

            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    allRestaurants = results.map(place => ({
                        ...place,
                        distance: calculateDistance(location, {
                            lat: place.geometry.location.lat(),
                            lng: place.geometry.location.lng()
                        })
                    }));
                    displayResults(allRestaurants);
                    addMarkers(allRestaurants);
                } else {
                    alert('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
                hideLoading();
            });
        }

        // è¨ˆç®—è·é›¢ï¼ˆå…¬é‡Œï¼‰
        function calculateDistance(pos1, pos2) {
            const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
            const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
            const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(2);
        }

        // æ–°å¢åœ°åœ–æ¨™è¨˜
        function addMarkers(restaurants) {
            restaurants.forEach((place, index) => {
                const marker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: place.name,
                    label: (index + 1).toString()
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 5px 0;">${place.name}</h3>
                            <p style="margin: 0; color: #666;">${place.vicinity}</p>
                            <p style="margin: 5px 0 0 0; color: #ffc107; font-weight: bold;">
                                â­ ${place.rating || 'N/A'}
                            </p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });
        }

        // é¡¯ç¤ºæœå°‹çµæœ
        function displayResults(restaurants) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = resultContext
            const resultsCount = document.getElementById('resultsCount');

            resultsCount.textContent = `${restaurants.length} é–“é¤å»³`;

            if (restaurants.length === 0) {
                resultsContainer.innerHTML += `
                    <div class="no-results">
                        <div class="no-results-icon">ğŸ˜”</div>
                        <h3>æ‰¾ä¸åˆ°é¤å»³</h3>
                        <p>é™„è¿‘ 1 å…¬é‡Œå…§æ²’æœ‰æ‰¾åˆ°é¤å»³ï¼Œè«‹å˜—è©¦å…¶ä»–åœ°å€</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="results-header">
                    <h2>æœå°‹çµæœ</h2>
                    <span class="results-count">${restaurants.length} é–“é¤å»³</span>
                </div>
            `;

            restaurants.forEach((place, index) => {
                const isOpen = place.opening_hours?.open_now;
                html += `
                    <div class="restaurant-card" onclick="focusMarker(${index})">
                        <div class="restaurant-header">
                            <div>
                                <div class="restaurant-name">${index + 1}. ${place.name}</div>
                                <div class="restaurant-rating">
                                    â­ ${place.rating || 'N/A'}
                                    ${place.user_ratings_total ? `(${place.user_ratings_total})` : ''}
                                </div>
                            </div>
                            <span class="distance-badge">${place.distance} km</span>
                        </div>
                        <div class="restaurant-info">
                            <div class="info-item">
                                <span class="info-icon">ğŸ“</span>
                                <span>${place.vicinity}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-icon">ğŸ·ï¸</span>
                                <span>${place.types?.slice(0, 3).join(', ') || 'é¤å»³'}</span>
                            </div>
                            ${place.opening_hours ? `
                                <div class="info-item">
                                    <span class="status-badge ${isOpen ? 'status-open' : 'status-closed'}">
                                        ${isOpen ? 'ğŸŸ¢ ç‡Ÿæ¥­ä¸­' : 'ğŸ”´ ä¼‘æ¯ä¸­'}
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
        }

        // èšç„¦åˆ°åœ°åœ–æ¨™è¨˜
        function focusMarker(index) {
            if (markers[index]) {
                map.setCenter(markers[index].getPosition());
                map.setZoom(17);
                google.maps.event.trigger(markers[index], 'click');
            }
        }

        // ç¯©é¸é¤å»³
        function filterRestaurants(type) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            currentFilter = type;
            let filtered = [...allRestaurants];

            switch(type) {
                case 'rating':
                    filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'open':
                    filtered = filtered.filter(r => r.opening_hours?.open_now);
                    break;
                case 'distance':
                    filtered.sort((a, b) => a.distance - b.distance);
                    break;
            }

            displayResults(filtered);
        }

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        function showLoading() {
            document.getElementById('results').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æœå°‹ä¸­ï¼Œè«‹ç¨å€™...</p>
                </div>
            `;
        }

        // éš±è—è¼‰å…¥ä¸­
        function hideLoading() {
            // Loading æœƒåœ¨é¡¯ç¤ºçµæœæ™‚è‡ªå‹•è¢«æ›¿æ›
        }

        // Enter éµæœå°‹
        document.getElementById('addressInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchByAddress();
            }
        });

        
        // æ¨¡æ“¬åˆå§‹åŒ–ï¼ˆå¯¦éš›ä¸Šæœƒç”± Google Maps API è‡ªå‹•å‘¼å«ï¼‰
        if (typeof google !== 'undefined') {
            initMap();
        }
    </script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" async defer></script>
</body>
</html>