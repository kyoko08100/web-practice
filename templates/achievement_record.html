<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é³´æ½®æˆå°±ç´€éŒ„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        .container {
            display: flex;
            height: 100vh;
            padding-top: 70px;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #111827;
            border-right: 1px solid #1f2933;
            overflow-y: auto;
        }

        .search-box {
            padding: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 12px 12px 10px;
            background: #020617;
            border: 1px solid #1e293b;
            border-radius: 10px;
            color: #e5e7eb;
        }

        .search-input::placeholder {
            color: #94a3b8;
        }

        .filters {
            padding: 0 20px 20px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .divider {
            height: 1px;
            background: #1e293b;
            margin: 0 20px 16px;
        }

        .category-header {
            padding: 0 20px 12px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #94a3b8;
        }

        /* Categories */
        .categories {
            padding: 0 12px 20px;
        }

        .category-item {
            padding: 14px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: #020617;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .category-item:hover {
            border-color: #334155;
        }

        .category-item.active {
            border-color: #6366f1;
            background: #020617;
        }

        .category-top {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .category-stats {
            font-size: 12px;
            color: #94a3b8;
        }

        /* Main content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .content-wrapper {
            max-width: 1100px;
            margin: auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .header-title h1 {
            font-size: 40px;
            color: #e5e7eb;
        }

        .header-subtitle {
            color: #94a3b8;
        }

        /* Achievements */
        .achievements {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .achievement-card {
            padding: 24px;
            border-radius: 14px;
            background: #020617;
            border: 1px solid #1e293b;
        }

        .achievement-right {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-left: 24px;
        }

        /*.achievement-card:hover {
            border-color: #475569;
        }*/

        .achievement-card.completed {
            border-color: #22c55e;
            background: #020617;
        }

        .achievement-content {
            display: flex;
            justify-content: space-between;
        }

        .achievement-title {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .achievement-desc {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .achievement-link {
            color: #FFD306;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .achievement-tags {
            display: flex;
            gap: 8px;
        }

        .achievement-tag {
            background: #1e293b;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
        }

        .achievement-points {
            font-size: 20px;
            color: #facc15;
        }

        .check-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .achievement-card.completed .check-circle {
            border-color: #22c55e;
            color: #22c55e;
        }


        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-text {
            color: #e9d5ff;
            font-size: 18px;
        }

        .categories {
            border-radius: 8px;
            overflow: hidden;
        }

        .categories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            background: #6366f1;
            font-weight: 600;
        }

        .categories-body {
            overflow: hidden;
            transition: max-height 0.35s ease, opacity 0.25s ease;
            max-height: 1000px;
            opacity: 1;
            margin-top: 8px;
        }

        .categories.collapsed .categories-body {
            max-height: 0;
            opacity: 0;
        }

        .arrow {
            transition: transform 0.3s ease;
        }

        .categories.collapsed .arrow {
            transform: rotate(-90deg);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
{% include "blog_nav.html" %}
<div class="container">
    <div class="sidebar">
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹æˆå°±...">
        </div>

        <div class="filters">
            <div class="filter-option">
                <input type="checkbox" id="filterHideCompleted" name="filter" value="all">
                <label for="filterHideCompleted">éš±è—å·²å®Œæˆ</label>
            </div>
            <div class="filter-option">
                <input type="checkbox" id="filterCompleted" name="filter" value="completed">
                <label for="filterCompleted">åƒ…é¡¯ç¤ºå·²å®Œæˆ</label>
            </div>
            <div class="filter-option">
                <input type="checkbox" id="filterHiddenAchi" name="filter" value="incomplete">
                <label for="filterHiddenAchi">åƒ…é¡¯ç¤ºéš±è—æˆå°±</label>
            </div>
        </div>

        <div class="divider"></div>

        <div class="category-header">
            <span class="category-title" id="categoryStats">ç¸½æˆå°±æ•¸ 0/0</span>
            <div class="category-buttons">
                <button class="icon-btn" id="importData">ğŸ“¥åŒ¯å…¥</button>
                <input type="file" id="file-input" accept=".json" style="display:none;">
                <button class="icon-btn" id="exportData">ğŸ“¥åŒ¯å‡º</button>
            </div>
        </div>

        <div class="categories" id="categoriesList">

        </div>
    </div>

    <div class="main-content">
        <div class="content-wrapper">
            <div class="header">
                <div class="header-title">
                    <h1 id="aciTitle"></h1>
                </div>
                <div class="header-buttons">
                    <button class="header-btn" id="selectAll">âœ“å…¨é¸</button>
                    <button class="header-btn" id="cancelAll">ğŸ“¥å…¨éƒ¨å–æ¶ˆ</button>
                    <button class="header-btn" id="updateAchi">ğŸ“¥æ›´æ–°æˆå°±</button>
                    {% csrf_token %}
                </div>
            </div>

            <div class="achievements" id="achievementsList"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    let achievementsData = {{ achievements|safe }}
    let achievements_state = {{ achievements_state|safe }}

    let state = {
        selectIndex: 0,
        selectedCategory: 'ç´¢æ‹‰æ¼«è¡Œ',
        selectedSubCategory: 'ç´¢æ‹‰çš„å¤§åœ°Â·ç‘ç“',
        searchTerm: '',
        filterHideCompleted: false,
        filterCompleted: false,
        filterHiddenAchi: false,
        completed: achievements_state
    };

    // æª¢æŸ¥ç€è¦½å™¨ä¸­æ˜¯å¦æœ‰å®Œæ•´çš„state
    let local = JSON.parse(localStorage.getItem("state"))
    if (!local) // é€£localStorage['state']éƒ½æ²’æœ‰
        localStorage.setItem("state", JSON.stringify(state));
    else { // æœ‰localStorage['state']ï¼Œæª¢æŸ¥å®Œæ•´æ€§
        for (let key in state) {
            if (!local.hasOwnProperty(key)) {
                let tempLocal = JSON.parse(localStorage.getItem("state"));
                tempLocal[key] = state[key];
                localStorage.setItem("state", tempLocal);
            } else {  // å¦‚æœå·²ç¶“æœ‰ä½¿ç”¨ç´€éŒ„ï¼Œæ›´æ–°å›state
                let tempLocal = JSON.parse(localStorage.getItem("state"));
                state[key] = tempLocal[key];
            }
        }
    }

    // æˆå°±è½‰ç·¨ç¢¼
    function getAchievementName(summary, category, key) {
        let cateIndex = achievementsData.findIndex(item => item.hasOwnProperty(category));
        let keyIndex = Object.keys(achievementsData[summary][category]).findIndex(item => item === key);
        return `${cateIndex}a${keyIndex}a`
    }

    function getCategoryStats(summary, category, key) {
        let aciName = getAchievementName(summary, category, key)
        let achievements = achievementsData[summary][category][key];
        let total = achievements.length;
        let all_a = JSON.parse(localStorage.getItem("state")).completed.filter(item => item.name.startsWith(aciName))
        let completed = all_a.filter(function (a) {
            return a.completed;
        }).length;
        let percentage = Math.round((completed / total) * 100);
        return {completed: completed, total: total, percentage: percentage};
    }

    // è¨ˆç®—æˆå°±ç¸½æ•¸
    function renderTotalStats() {
        let total = 0;
        let completed = 0;
        for (const s of state.completed) {
            if (s.completed)
                completed++;
            total++;
        }

        document.getElementById('categoryStats').textContent = 'æˆå°±åˆ†é¡ ' + completed + '/' + total;
    }

    // æ¸²æŸ“å·¦é‚Š
    function renderCategories() {
        let categoriesList = document.getElementById('categoriesList');

        categoriesList.innerHTML = '';
        for (let summary in achievementsData) {
            for (let category in achievementsData[summary]) {

                let sDiv = document.createElement('div');
                sDiv.classList.add('categories');
                sDiv.id = `category-${summary}`;
                let headerDiv = document.createElement('div');
                headerDiv.classList.add("categories-header");
                headerDiv.innerHTML = `ğŸ“‚ ${category}<span class="arrow">â–¾</span>`
                headerDiv.addEventListener("click", (e) => {
                    sDiv.classList.toggle("collapsed");
                })
                sDiv.appendChild(headerDiv);
                let bodyDiv = document.createElement('div');
                bodyDiv.classList.add("categories-body");
                let subCategory = achievementsData[summary][category];

                for (let key in subCategory) {
                    {#let stats = getCategoryStats(summary, category, key);#}
                    let div = document.createElement('div');
                    div.className = 'category-item' + (state.selectedSubCategory === key ? ' active' : '');
                    div.onclick = (function (s, c, k) {
                        return function () {
                            state.selectIndex = s;
                            state.selectedCategory = c;
                            state.selectedSubCategory = k;
                            localStorage.setItem("state", JSON.stringify(state));
                            if (categoriesList.querySelector('.active'))
                                categoriesList.querySelector('.active').classList.remove('active');
                            div.classList.add('active');

                            renderAchievements();
                        };
                    })(summary, category, key);
                    // å·¦å´é¡¯ç¤ºå·²å®Œæˆæ•¸é‡
                    let achName = getAchievementName(summary, category, key);
                    let ach = state.completed.filter(item => item.name.startsWith(achName));
                    let achComplete = ach.filter(item => item.completed).length;
                    {#let percentage = Math.round((achComplete / ach.length) * 100);#}
                    {#'<span class="category-percent' + (percentage === 100 ? ' complete' : '') + '">' + percentage + '%</span>' +#}

                    let html = '<div class="category-top">' +
                        '<div class="category-name">' +
                        '<span>' + key + '</span>' +
                        '</div>' +
                        '<span>â­ ' + achComplete + '</span>' +
                        '<span>' + achComplete + '/' + ach.length + '</span>' +
                        '</div>' +
                        '<div class="category-stats">' +
                        '</div>';

                    div.innerHTML = html;
                    bodyDiv.appendChild(div);
                }
                sDiv.appendChild(bodyDiv);
                categoriesList.appendChild(sDiv);
            }
        }

    }

    // æ¸²æŸ“å³é‚Š
    function renderAchievements() {
        let achievementsList = document.getElementById('achievementsList');
        let currentAchievements = achievementsData[state.selectIndex][state.selectedCategory][state.selectedSubCategory];
        document.getElementById("aciTitle").innerHTML = state.selectedSubCategory;
        let achiPrefix = getAchievementName(state.selectIndex, state.selectedCategory, state.selectedSubCategory)
        
        achievementsList.innerHTML = '';
        for (let i = 0; i < currentAchievements.length; i++) {
            let achievement = currentAchievements[i]; // åŸå§‹æˆå°±json
            // çµ±è¨ˆæ˜¯å¦å®Œæˆç”¨json
            let achName = getAchievementName(state.selectIndex, state.selectedCategory, state.selectedSubCategory);
            let ach = state.completed.filter(item => item.name === `${achName}${i}`)
            // ç¯©é¸æ¢ä»¶: æœå°‹æ¬„+ä¸‰å€‹å‹¾å‹¾
            let matches = achievement["åç¨±"].toLowerCase().indexOf(state.searchTerm.toLowerCase()) !== -1 ||
                achievement["æè¿°"].toLowerCase().indexOf(state.searchTerm.toLowerCase()) !== -1 ||
                achievement["ç‰ˆæœ¬"].toLowerCase().indexOf(state.searchTerm.toLowerCase()) !== -1;
            let achi = state.completed.filter(item => item.name === `${achiPrefix}${i}`)[0]
            if (state.filterHideCompleted) {
                matches = matches && !achi.completed
            }
            if (state.filterCompleted) {
                matches = matches && achi.completed
            }
            if (state.filterHiddenAchi) {
                matches = matches && achievement["åç¨±"].startsWith("ã€Œéš±è—æˆå°±ã€")
            }
            if (!matches)
                continue;


            let div = document.createElement('div');
            div.className = 'achievement-card' + (ach[0].completed ? ' completed' : '');
            let html = '<div class="achievement-content">' +
                '<div class="achievement-info">';
            if (achievement["åç¨±"].startsWith("ã€Œéš±è—æˆå°±ã€")) {
                html += '<h3 class="achievement-title">' + achievement["åç¨±"].substring(6) + '</h3>' +
                    '<p class="achievement-desc">' + achievement["æè¿°"] + '</p>' +
                    '<div class="achievement-tags">' +
                    '<span class="achievement-tag">éš±è—</span>'
            } else {
                html += '<h3 class="achievement-title">' + achievement["åç¨±"] + '</h3>' +
                    '<p class="achievement-desc">' + achievement["æè¿°"] + '</p>' +
                    '<p class="achievement-link">' + "å½±ç‰‡é€£çµï¼š" +
                    `<a href="" target="_blank" class="achievement-link">é€£çµ</a>` +
                    '</p>' +
                    '<div class="achievement-tags">'
            }
            html += '<span class="achievement-tag">' + achievement["ç‰ˆæœ¬"] + '</span>' +
                '</div>' +
                '</div>' +
                '<div class="achievement-right">' +
                '<span class="achievement-points">' + achievement["çå‹µ"] + ' â­</span>' +
                '<div class="check-circle">' + (ach[0].completed ? 'âœ“' : '') + '</div>' +
                '</div>' +
                '</div`>';

            div.innerHTML = html;
            div.querySelector(".check-circle").onclick = (function () {
                return function () {
                    ach[0].completed = !ach[0].completed;
                    localStorage.setItem("state", JSON.stringify(state));
                    render();
                };
            })();
            achievementsList.appendChild(div);
        }

        if (achievementsList.innerHTML === '') {
            let emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-state';
            emptyDiv.innerHTML = '<div class="empty-icon">ğŸ”</div><p class="empty-text">æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æˆå°±</p>';
            achievementsList.appendChild(emptyDiv);
        }
    }

    function render() {
        renderCategories();
        renderAchievements();
        renderTotalStats();
    }

    // æœå°‹
    document.getElementById('searchInput').addEventListener('input', function (e) {
        state.searchTerm = e.target.value;
        localStorage.setItem("state", JSON.stringify(state));
        render();
    });

    // ä¸‰å€‹å‹¾å‹¾
    let filterRadios = document.querySelectorAll('input[name="filter"]');
    for (let i = 0; i < filterRadios.length; i++) {
        filterRadios[i].addEventListener('change', function (e) {
            state[filterRadios[i].id] = filterRadios[i].checked;
            localStorage.setItem("state", JSON.stringify(state));
            render();
        });
    }

    // åŒ¯å‡º
    document.getElementById("exportData").addEventListener("click", () => {
        // å¾ localStorage å–è³‡æ–™
        const data = JSON.parse(localStorage.getItem("state"));
        const achiData = data.completed

        console.log(achiData);
        if (!achiData) {
            alert("localStorage æ²’æœ‰è³‡æ–™ï¼");
            return;
        }

        // è½‰æˆ Blob
        const jsonStr = JSON.stringify(achiData, null, 2); // JSONè½‰å­—ä¸²
        const blob = new Blob([jsonStr], {type: "application/json"});

        // å»ºç«‹ä¸‹è¼‰ç”¨çš„ URL
        const url = URL.createObjectURL(blob);

        // å»ºç«‹è‡¨æ™‚ a æ¨™ç±¤ï¼Œè§¸ç™¼ä¸‹è¼‰
        const a = document.createElement("a");
        a.href = url;
        a.download = "achievements.json"; // ä¸‹è¼‰æª”å
        document.body.appendChild(a);
        a.click();

        // æ¸…ç†
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    const uploadBtn = document.getElementById("importData");
    const fileInput = document.getElementById("file-input");

    uploadBtn.addEventListener("click", () => {
        fileInput.click(); // é»æŒ‰éˆ•å°±æ‰“é–‹æª”æ¡ˆé¸æ“‡æ¡†
    });

    // åŒ¯å…¥
    fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const fileReader = new FileReader();

        fileReader.onload = (event) => {
            try {
                // 1ï¸âƒ£ è§£æ JSON
                const importedData = JSON.parse(event.target.result);

                // 2ï¸âƒ£ æª¢æŸ¥æ ¼å¼
                if (!Array.isArray(importedData) && typeof importedData !== 'object') {
                    alert("æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼");
                    return;
                }

                // 3ï¸âƒ£ æ›´æ–° localStorage
                const stateStr = localStorage.getItem("state");
                let stateObj = stateStr ? JSON.parse(stateStr) : {};
                stateObj.completed = importedData; // è¦†è“‹ä¹‹å‰çš„ completed
                localStorage.setItem("state", JSON.stringify(stateObj));
                state.completed = importedData;

                alert("åŒ¯å…¥å®Œæˆï¼");
                render();
            } catch (err) {
                console.error(err);
                alert("JSON è§£æå¤±æ•—ï¼");
            }
        };
        fileInput.value = "";
        fileReader.readAsText(file);
    });

    // å…¨é¸
    document.getElementById("selectAll").addEventListener("click", () => {
        const achis = document.querySelectorAll(".achievement-card")
        achis.forEach(achi => {
            if (!achi.classList.contains('completed')) {
                const circle = achi.querySelector(".check-circle")
                circle.click();
            }
        })
    });

    // å…¨éƒ¨å–æ¶ˆ
    document.getElementById("cancelAll").addEventListener("click", () => {
        const achis = document.querySelectorAll(".achievement-card")
        achis.forEach(achi => {
            if (achi.classList.contains('completed')) {
                const circle = achi.querySelector(".check-circle")
                circle.click();
            }
        })
    });

    // æ›´æ–°æˆå°±
    const updateBtn = document.getElementById("updateAchi");

    updateBtn.addEventListener("click", () => {
        updateBtn.disabled = true;
        updateBtn.innerHTML = "æ›´æ–°ä¸­...";
        let updateUrl = "{% url 'update_achievements' %}";
        axios.get(updateUrl, {
            headers: {
                "Content-Type": "multipart/form-data"
            }
        }).then(response => {
            if (response.status === 200) {
                achievementsData = JSON.parse(response.data.achievements);
                alert("æ›´æ–°å®Œæˆ!")
                render();
                updateBtn.innerHTML = "ğŸ“¥æ›´æ–°æˆå°±";
                updateBtn.disabled = false;
            }
        });
    });

    render();

</script>
</body>
</html>